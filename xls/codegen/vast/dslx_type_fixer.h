// Copyright 2025 The XLS Authors
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

#ifndef XLS_CODEGEN_VAST_DSLX_TYPE_FIXER_H_
#define XLS_CODEGEN_VAST_DSLX_TYPE_FIXER_H_

#include <memory>

#include "xls/dslx/frontend/ast_cloner.h"
#include "xls/dslx/frontend/module.h"
#include "xls/dslx/import_data.h"
#include "xls/dslx/type_system/type_info.h"
#include "xls/dslx/type_system_v2/type_inference_error_handler.h"

namespace xls {

// A utility used internally by a `DslxBuilder` to perform final cleanup on an
// AST generated by VAST->DSLX translation. The builder performs a preliminary
// run of DSLX type inference on a "draft" of its generated DSLX. It then
// provides the resulting `TypeInfo` to the fixer, which uses the info to make
// decisions.
class DslxTypeFixer {
 public:
  virtual ~DslxTypeFixer() = default;

  // Returns an error handler that can fix type errors in the draft of the
  // generated DSLX. After running type inference with this handler, the
  // replacer returned by GetReplacer() injects any needed fixes that were
  // discovered by the error handler.
  virtual dslx::TypeInferenceErrorHandler GetErrorHandler() = 0;

  // Deals out a `CloneReplacer` that can be used to transform the draft AST
  // into a fixed AST.
  virtual dslx::CloneReplacer GetErrorFixReplacer(const dslx::TypeInfo* ti) = 0;

  // Deals out a `CloneReplacer` that can be used to transform the draft AST
  // into a fixed AST.
  virtual dslx::CloneReplacer GetSimplifyReplacer(const dslx::TypeInfo* ti) = 0;
};

// Deals out a type fixer.
std::unique_ptr<DslxTypeFixer> CreateDslxTypeFixer(
    dslx::Module& original_module, const dslx::ImportData& import_data);

}  // namespace xls

#endif  // XLS_CODEGEN_VAST_DSLX_TYPE_FIXER_H_
