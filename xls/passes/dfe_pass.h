// Copyright 2020 The XLS Authors
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

// Dead Function Elimination.
//
#ifndef XLS_PASSES_DFE_PASS_H_
#define XLS_PASSES_DFE_PASS_H_

#include <string_view>

#include "absl/status/statusor.h"
#include "xls/ir/package.h"
#include "xls/passes/optimization_pass.h"
#include "xls/passes/pass_base.h"

namespace xls {

// Dead Function Elimination.
//
// Note: What follows was generated by the Gemini LLM. Not human verified.
//
// This pass removes unreachable functions, procs, and blocks (collectively
// `FunctionBase`s) from the package. It is crucial for reducing the size and
// complexity of the IR by discarding any components that do not contribute to
// the final output of the top-level entity.
//
// The pass requires that a `top` entity (function, proc, or block) be set in
// the package to determine the starting point of liveness analysis.
//
// The process involves:
//
// 1.  **Identifying Live Roots**: The pass first identifies the initial set of
//     "live" `FunctionBase`s. This typically includes:
//     *   The explicitly designated top-level function, proc, or block.
//
//     *   For old-style procs, any proc that communicates with external
//         channels (e.g., `send_only` or `receive_only`) is considered live.
//         Liveness then propagates to other procs that communicate with these
//         live procs over internal channels.
//
//     *   For new-style procs and blocks, liveness is determined by which other
//         procs or blocks are instantiated by the top-level proc/block.
//
// 2.  **Transitive Closure Analysis**: A depth-first search (DFS) is performed
//     starting from these live roots. During this traversal, all directly or
//     indirectly referenced `FunctionBase`s (e.g., functions invoked by other
//     functions, `body` functions of `counted_for` loops, instantiated blocks)
//     are marked as "reached" or "live".
//
// 3.  **Elimination of Dead Code**: After the traversal:
//     *   Any `FunctionBase` that was not marked as reached is considered dead
//         and is removed from the package.
//
//     *   Any channels that are no longer associated with any live proc are
//         also removed.
//
// This pass ensures that the final IR contains only the necessary logic,
// simplifying subsequent optimization and synthesis steps.
//
// Example:
// Consider a package with three functions: `f_live`, `f_dead`, and `f_top`.
// `f_top` is set as the top entity and invokes `f_live`. `f_dead` is defined
// but never invoked by `f_top` or `f_live`.
//
//
// ```
// package my_package
//
// fn f_dead() -> bits[32] {
//   ret literal.0: bits[32] = literal(value=42)
// }
//
// fn f_live(x: bits[32]) -> bits[32] {
//   ret add.1: bits[32] = add(x, literal(value=1))
// }
//
// top fn f_top(y: bits[32]) -> bits[32] {
//   invoke.0: bits[32] = invoke(y, to_apply=f_live)
//   ret invoke.0
// }
// ```
//
//
// After `DeadFunctionEliminationPass` runs, `f_dead` will be removed, and the
// package will contain only `f_live` and `f_top`.
class DeadFunctionEliminationPass : public OptimizationPass {
 public:
  static constexpr std::string_view kName = "dfe";
  explicit DeadFunctionEliminationPass()
      : OptimizationPass(kName, "Dead Function Elimination") {}
  ~DeadFunctionEliminationPass() override = default;

 protected:
  // Iterate all nodes and mark and eliminate unreachable functions.
  absl::StatusOr<bool> RunInternal(Package* p,
                                   const OptimizationPassOptions& options,
                                   PassResults* results,
                                   OptimizationContext& context) const override;
};

}  // namespace xls

#endif  // XLS_PASSES_DFE_PASS_H_
